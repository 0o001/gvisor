steps:
  - label: ":pipeline: Smoke tests"
    command: make pipeline-smoke-tests | buildkite-agent pipeline upload
  - wait

  - label: ":pipeline: Source tests"
    command: make pipeline-source-tests | buildkite-agent pipeline upload
  - wait

  - label: ":ship: Artifacts"
    commands:
      # Create artifacts for use by subsequent steps. These will generate
      # artifacts that are automatically downloaded in the pre-command hook,
      # and will be automatically used by the integration tests.
      - make release-artifacts
      - buildkite-agent upload "artifacts/**/*"
  - wait

  - label: ":pipeline: Integration tests"
    command: make pipeline-integration-tests | buildkite-agent pipeline upload
  - label: ":pipeline: Containerd tests"
    # Include agents from both cgroupv1 and cgroupv2 queues into the mix. Note
    # that while the queue is cgroupv1 or cgroupv2, these agents can also execute
    # jobs in the default queue.
    command: '(echo -e "agents:\n  queue: cgroupv1" && make pipeline-containerd-tests CGROUPv2=false) | buildkite-agent pipeline upload'
  - label: ":pipeline: Containerd tests"
    command: '(echo -e "agents:\n  queue: cgroupv2" && make pipeline-containerd-tests CGROUPV2=true)  | buildkite-agent pipeline upload'
  - label: ":pipeline: Network tests"
    command: make pipeline-network-tests | buildkite-agent pipeline upload
  - label: ":pipeline: Runtime tests"
    command: make pipeline-runtime-tests | buildkite-agent pipeline upload
  - label: ":pipeline: Benchmarks"
    command: make pipeline-benchmarks | buildkite-agent pipeline upload
